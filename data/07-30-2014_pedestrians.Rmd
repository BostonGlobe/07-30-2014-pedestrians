---
title: "07-30-2014_pedestrians"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
setwd("~/Documents/dev/07-30-2014_pedestrians/data")

# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

library(zoo)
library(stringr)
library(lubridate)
library(RColorBrewer)
library(rgdal)
library(rgeos)
library(tidyr)
library(dplyr)
library(ggmap)
library(ggplot2)

# read shapefiles
crashes.shp <- readOGR('downloaded/pedestriancrashes/shp','pedestriancrashes',  p4s='+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')
tracts.shp <- readOGR('downloaded','cb_2013_25_tract_500k',p4s='+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')
state.shp <- readOGR('downloaded','cb_2013_ma_state_500k', p4s='+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')
towns.shp <- readOGR('downloaded','MA_TOWNS',              p4s='+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

# add tract information to each crash
# standardize dates
# reject bad dates, e.g. 2041
crashes <- over(crashes.shp, tracts.shp) %>%
  cbind(crashes.shp@data) %>%
  cbind(crashes.shp@coords) %>%
  mutate(DATE = mdy(Crash.Date)) %>%
  filter(year(today()) >= year(DATE))

# calculate crashes per year for each town
yearlyCrashesPerTown <- crashes %>%
  mutate(YEAR=year(DATE)) %>%
  group_by(YEAR,City.Town) %>%
  summarise(crashes = n())

# create tracts dataframe
tracts <- tracts.shp@data %>%
  left_join(crashes %>%
              group_by(GEOID) %>%
              summarise(crashes = n()),by='GEOID') %>%
  arrange(desc(crashes))

# create towns dataframe
# add town centroids
# add town boundaries
# add total crashes per town
towns <- towns.shp@data %>%
  cbind(gCentroid(towns.shp,byid=T)@coords) %>%
  cbind(fortify(gEnvelope(towns.shp,byid=T)) %>%
          mutate(id=as.numeric(id)) %>%
          group_by(id) %>%
          summarise(
            E=min(long),
            W=max(long),
            S=min(lat),
            N=max(lat)
          ) %>%
          arrange(id)) %>%
  left_join(yearlyCrashesPerTown %>%
              group_by(City.Town) %>%
              summarise(crashes = sum(crashes)) %>%
              mutate(TOWN=City.Town) %>% select(-City.Town),by='TOWN')

state <- state.shp@data %>%
  cbind(fortify(gEnvelope(state.shp,byid=T)) %>%
          mutate(id=as.numeric(id)) %>%
          group_by(id) %>%
          summarise(
            E=min(long),
            W=max(long),
            S=min(lat),
            N=max(lat)
          ) %>%
          arrange(id))
  
# fortify for mapping purposes
tracts.fortified <- fortify(tracts.shp,region='GEOID')
state.fortified <- fortify(state.shp,region='GEOID')
towns.fortified <- fortify(towns.shp,region='TOWN')

population <- read.csv('population_by_state_00_13.csv',strip.white=T,stringsAsFactors=F) %>%
  gather(Year,Population,-Place) %>%
  mutate(
    YEAR=as.numeric(gsub('^X','',Year)),
    Population=as.numeric(gsub(',','',Population)),
    Place=gsub('^\\.','',Place)
  ) %>%
  filter(Place=='Massachusetts') %>%
  select(-Place,-Year)
```

Let's explore the question: are pedestrian crashes increasing?

```{r, echo=FALSE, fig.width=12, fig.height=7}

data <- crashes %>%
  mutate(DATE=floor_date(DATE,'year')) %>%
  group_by(DATE) %>%
  summarise(count = n()) %>%
  filter(year(DATE) >= 2002) %>%
  arrange(DATE)

ggplot(data,aes(DATE,count)) +
  geom_line() +
  ggtitle(str_c('Massachusetts pedestrian crashes, ',year(min(data$DATE)),'-',year(max(data$DATE)))) +
  xlab('year')
```

It seems so.

***

But maybe the population is increasing as well? What if we normalize by population?

```{r, echo=FALSE, fig.width=12, fig.height=7}

data <- crashes %>%
  mutate(YEAR=year(DATE)) %>%
  group_by(YEAR) %>%
  summarise(count = n()) %>%
  filter(YEAR >= 2002) %>%
  left_join(population,by='YEAR') %>%
  mutate(
    DATE=as.Date(as.yearmon(YEAR)),
    rate=count/Population * 100
  ) %>%
  arrange(YEAR)

ggplot(data,aes(DATE,rate)) +
  geom_line() +
  ggtitle(str_c('Massachusetts pedestrian crashes per capita, ',year(min(data$DATE)),'-',year(max(data$DATE)))) +
  xlab('year') +
  ylab('crashes per 10,000')
```

The state's population hasn't increased significantly, hence the rate looks pretty similar to the raw count. So what's going on? What explains the significant increase in crashes starting in 2010? According to MassDOT(?) expert FirstName LastName, in 2010 municipalities started working on improving accident reporting. This is important because better reporting leads to more money from the state.

***

Can we analyse this data to see which towns are working on their reporting?

```{r, echo=FALSE, fig.width=12, fig.height=7}

data <- towns %>%
  arrange(desc(crashes)) %>%
  head(5) %>%
  select(City.Town=TOWN) %>%
  left_join(yearlyCrashesPerTown,by='City.Town') %>%
  mutate(DATE=as.Date(as.yearmon(YEAR))) %>%
  filter(year(DATE) >= 2002)

ggplot(data,aes(DATE,crashes,group=City.Town)) +
  geom_line(aes(color=City.Town=='BOSTON')) +
  geom_text(data=filter(data,YEAR==max(YEAR)),aes(DATE,crashes,label=City.Town),hjust=1,vjust=-0.5,size=3) +
  ggtitle(str_c('Towns with most pedestrian crashes, ',min(data$YEAR),'-',max(data$YEAR))) +
  theme(legend.position='none')
```

Boston's reporting inconsistency is striking.

***

What about other towns?

```{r, echo=FALSE, fig.width=12, fig.height=12}

data <- towns %>%
  filter(crashes>50) %>%
  arrange(desc(crashes)) %>%
  select(City.Town=TOWN) %>%
  left_join(yearlyCrashesPerTown,by='City.Town') %>%
  mutate(DATE=as.Date(as.yearmon(YEAR))) %>%
  filter(year(DATE) >= 2002)

ggplot(data,aes(DATE,crashes,group=City.Town)) +
  geom_line() +
  ggtitle(str_c('Pedestrian crashes in towns with greater than 50 crashes in period ',min(data$YEAR),'-',max(data$YEAR),'. Y-scale is relative to each town.')) +
  facet_wrap(~City.Town,scales='free',ncol=8) +
  theme(
    axis.ticks=element_blank(),
    axis.text=element_blank(),
    panel.grid = element_blank()
  )
```

It seems that Barnstable and Springfield didn't report pedestrian accidents prior to 2010.

***

Let's look at the top five towns over time.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE}

data_towns <- towns %>%
  arrange(desc(crashes))

data_crashes <- crashes %>%
  mutate(YEAR=year(DATE)) %>%
  group_by(coords.x1,coords.x2,YEAR) %>%
  summarise(crashes=n()) %>%
  filter(coords.x2 >= state$S & coords.x2 <= state$N) %>%
  arrange(desc(crashes))

ggmap(get_map(location=str_c(data_towns[1,]$TOWN,', MA'),zoom=12,maptype='roadmap')) +
  geom_point(data=data_crashes,aes(x=coords.x1,y=coords.x2,group=YEAR,size=crashes)) +
  geom_path(data=filter(towns.fortified,id==data_towns[1,]$TOWN),aes(x=long,y=lat,group=group),size=0.25) +
  facet_wrap(~YEAR,nrow=4) +
  ggtitle(str_c('Pedestrian crashes in ',data_towns[1,]$TOWN)) +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

ggmap(get_map(location=str_c(data_towns[2,]$TOWN,', MA'),zoom=12,maptype='roadmap')) +
  geom_point(data=data_crashes,aes(x=coords.x1,y=coords.x2,group=YEAR,size=crashes)) +
  geom_path(data=filter(towns.fortified,id==data_towns[2,]$TOWN),aes(x=long,y=lat,group=group),size=0.25) +
  facet_wrap(~YEAR,nrow=4) +
  ggtitle(str_c('Pedestrian crashes in ',data_towns[2,]$TOWN)) +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

ggmap(get_map(location=str_c(data_towns[3,]$TOWN,', MA'),zoom=12,maptype='roadmap')) +
  geom_point(data=data_crashes,aes(x=coords.x1,y=coords.x2,group=YEAR,size=crashes)) +
  geom_path(data=filter(towns.fortified,id==data_towns[3,]$TOWN),aes(x=long,y=lat,group=group),size=0.25) +
  facet_wrap(~YEAR,nrow=4) +
  ggtitle(str_c('Pedestrian crashes in ',data_towns[3,]$TOWN)) +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

ggmap(get_map(location=str_c(data_towns[4,]$TOWN,', MA'),zoom=12,maptype='roadmap')) +
  geom_point(data=data_crashes,aes(x=coords.x1,y=coords.x2,group=YEAR,size=crashes)) +
  geom_path(data=filter(towns.fortified,id==data_towns[4,]$TOWN),aes(x=long,y=lat,group=group),size=0.25) +
  facet_wrap(~YEAR,nrow=4) +
  ggtitle(str_c('Pedestrian crashes in ',data_towns[4,]$TOWN)) +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

ggmap(get_map(location=str_c(data_towns[5,]$TOWN,', MA'),zoom=12,maptype='roadmap')) +
  geom_point(data=data_crashes,aes(x=coords.x1,y=coords.x2,group=YEAR,size=crashes)) +
  geom_path(data=filter(towns.fortified,id==data_towns[5,]$TOWN),aes(x=long,y=lat,group=group),size=0.25) +
  facet_wrap(~YEAR,nrow=4) +
  ggtitle(str_c('Pedestrian crashes in ',data_towns[5,]$TOWN)) +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )
```
